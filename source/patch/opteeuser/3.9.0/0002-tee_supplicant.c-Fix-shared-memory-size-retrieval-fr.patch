From fa1d30c95d6f84cffed59220c0443709c303866c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Timoth=C3=A9e=20Cercueil?= <timothee.cercueil@st.com>
Date: Mon, 17 May 2021 14:50:55 +0200
Subject: [PATCH] tee_supplicant.c: Fix shared memory size retrieval from OPTEE
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The shared memory size got from tee_shm object already strips offset
from total buffer size.
The offset substraction breaks memref parameters through RPC when
applying offset to them.

Signed-off-by: Timoth√©e Cercueil <timothee.cercueil@st.com>
Reviewed-by: Etienne Carriere <etienne.carriere@linaro.org>
Reviewed-by: Jens Wiklander <jens.wiklander@linaro.org>
---
 tee-supplicant/src/tee_supplicant.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/tee-supplicant/src/tee_supplicant.c b/tee-supplicant/src/tee_supplicant.c
index 895d811..1da3995 100644
--- a/tee-supplicant/src/tee_supplicant.c
+++ b/tee-supplicant/src/tee_supplicant.c
@@ -257,7 +257,7 @@ static int get_param(size_t num_params, struct tee_ioctl_param *params,
 		return -1;
 
 	shm->flags = TEEC_MEM_INPUT | TEEC_MEM_OUTPUT;
-	shm->size = sz - offs;
+	shm->size = sz;
 	shm->id = MEMREF_SHM_ID(params + idx);
 	shm->buffer = (uint8_t *)tshm->p + offs;
 
-- 
2.17.1

